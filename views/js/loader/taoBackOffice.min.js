define("tpl!taoBackOffice/tpl/tooltip",["handlebars"],function(hb){return hb.template({compiler:[8,">= 4.3.0"],main:function(container,depth0,helpers,partials,data){var helper,lookupProperty=container.lookupProperty||function(parent,propertyName){return Object.prototype.hasOwnProperty.call(parent,propertyName)?parent[propertyName]:void 0};return"<div class=\"tooltip-container\">\n    <span class=\"tooltipstered\" data-tooltip=\"~ .tooltip-content\" data-tooltip-theme=\"info\"></span>\n    <div class=\"tooltip-content\">\n        "+container.escapeExpression((helper=null==(helper=lookupProperty(helpers,"message")||(null==depth0?depth0:lookupProperty(depth0,"message")))?container.hooks.helperMissing:helper,"function"==typeof helper?helper.call(null==depth0?container.nullContext||{}:depth0,{name:"message",hash:{},data:data,loc:{start:{line:4,column:8},end:{line:4,column:19}}}):helper))+"\n    </div>\n</div>"},useData:!0})}),define("css!taoBackOfficeCss/list",[],function(){}),define("taoBackOffice/controller/list/index",["jquery","i18n","uri","util/url","ui/feedback","ui/dialog/confirm","layout/section","core/request","tpl!taoBackOffice/tpl/tooltip","ui/tooltip","css!taoBackOfficeCss/list"],function($,__,Uri,urlUtil,feedback,dialogConfirm,section,request,tooltipTpl,tooltip){"use strict";function findListContainer(uri){return $(`#list-data_${uri}`)}function clearUri(value){return value.replace(/^list-element_[0-9]+_/,"")}function createEditUriCheckbox(id){const $checkbox=$("<input>").attr("type","checkbox").attr("id",id).attr("data-testid","editUriCheckbox").change(handleEditCheckboxStateChange),$label=$("<label>").attr("for",id).text(__("Edit URI")).focus();return $("<span>").addClass("lft edit-uri").append($checkbox,$label)}function createButton(title,icon){let position=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"rgt";const $btn=$("<button>",{class:`btn-info small ${position} icon-${icon}`,"data-testid":`${icon}ElementButton`,title:__(title)});return $btn}function transformListElement($element){return createListElement($element.attr("id"),$element.text())}function createNewListElement(elementId){return createListElement(`list-element_${elementId}_`)}function createListElement(name){let value=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"";const uri=Uri.decode(clearUri(name));return $(`<div class='list-element'>
            <div class='list-element'>
                <div class='list-element__input-container'>
                    <input type='text' name='${name}' value='${value}' data-testid='elementNameInput' data-former-value='${value}'/>
                    <div class='list-element__input-container__uri'>
                        <label for='uri_${name}' class='title'>URI</label>
                        <input id='uri_${name}' type='text' name='uri_${name}' value='${uri}' data-former-value='${uri}' data-testid='elementUriInput'>
                    </div>
                </div>
                <span class='icon-checkbox-crossed list-element-delete-btn' data-testid='deleteElementButton'>
            </div>
        </div>`)}function handleEditCheckboxStateChange(){findListContainer($(this).attr("id")).toggleClass("with-uri")}function showElementsEditControls($listContainer){$listContainer.find("span.list-element").replaceWith(function(){return transformListElement($(this))})}function handleEditList(targetUri){function isLimitReached(){return totalItems>=maxItems}const uri=getUriValue(targetUri),$listContainer=findListContainer(uri),list=$listContainer.find("ol"),offset=list.children("[id^=list-element]").length,batchSize=100;let totalItems=0,maxItems=1e3;0!==$("#data-max-items").length&&(maxItems=parseInt($("#data-max-items").val(),10)),loadListElements(uri,offset,batchSize).then(newListData=>{function toggleAddButton(isDisabled){$listNewBtn.attr("disabled",isDisabled),$tooltip.toggleClass("tooltip-hidden",!isDisabled)}function hasChangedListItemValue(form,item){const formerValue=$("[name=\""+item.name+"\"]",form).data("formerValue"),formerURI=$("[name=\"uri_"+item.name+"\"]",form).data("formerValue"),newURI=$("[name=\"uri_"+item.name+"\"]",form).val();return""==formerURI.trim()||formerValue!=item.value||formerURI!=newURI}function hasChangedListItemURI(form,item){const cleanName=item.name.substring(4),formerURI=$("[name=\""+item.name+"\"]",form).data("formerValue"),formerValue=$("[name=\""+cleanName+"\"]",form).data("formerValue"),newValue=$("[name=\""+cleanName+"\"]",form).val();return""==formerURI.trim()||formerValue!=newValue||formerURI!=item.value}function listItemHasChanged(form,item){return!(item.hasOwnProperty("name")&&item.hasOwnProperty("value"))||(item.name.startsWith("list-element_")?hasChangedListItemValue(form,item):!item.name.startsWith("uri_list-element_")||hasChangedListItemURI(form,item))}extendListWithNewElements(newListData,$listContainer);const saveUrl=urlUtil.route("saveLists","Lists","taoBackOffice"),delEltUrl=urlUtil.route("removeListElement","Lists","taoBackOffice");let $listForm=$listContainer.find("form");const $listTitleBar=$listContainer.find(".container-title h6"),$listToolBar=$listContainer.find(".data-container-footer").empty(),$tooltip=$(tooltipTpl({message:__("Maximum allowed number of elements is reached, you cannot add more elements. Please contact your administrator.")}));let $listSaveBtn,$listNewBtn;if(totalItems=newListData.totalCount,!$listForm.length){let nextElementId=totalItems;$listForm=$("<form>"),$listContainer.wrapInner($listForm),$listContainer.find("form").append(`<input type='hidden' name='uri' value='${uri}' />`);const $labelEdit=$(`<input type='text' name='label' value='' data-testid='listNameInput' />`).val($listTitleBar.text()),$listNewContainer=$("<div></div>",{class:"add-button-container"});$listTitleBar.closest(".container-title").html($labelEdit),$labelEdit.focus(),showElementsEditControls($listContainer),$listSaveBtn=createButton(__("Save list"),"save"),$listSaveBtn.on("click",function(){const form=$(this).closest("form");return $.postJson(saveUrl,form.serializeArray().filter(item=>listItemHasChanged(form,item)),response=>{if(response.saved)feedback().success(__("List saved")),section.get("taoBo_list").loadContentBlock(urlUtil.route("index","Lists","taoBackOffice"));else{const errors=(response.errors||[]).length?`<ul><li>${response.errors.join("</li><li>")}</li></ul>`:"";feedback().error(`${__("List not saved")}${errors}`,{encodeHtml:!1})}}),!1}),$listNewBtn=createButton("New element","add"),$listNewBtn.click(function(){const $list=$(this).closest("form").find("ol");return++totalItems,toggleAddButton(isLimitReached()),$list.append($("<li>").append(createNewListElement(nextElementId++))).closest(".container-content").scrollTop($list.height()),!1}),$listNewContainer.append($listNewBtn,$tooltip),$listToolBar.append($listSaveBtn,$listNewContainer,createEditUriCheckbox(uri)),tooltip.lookup($listNewContainer),toggleAddButton(isLimitReached())}$listContainer.on("click",".list-element-delete-btn",function(){const $element=$(this).closest("li"),$input=$element.find("input:text"),eltUri=clearUri($input.attr("name")),deleteLocalElement=()=>{$element.remove(),--totalItems,toggleAddButton(isLimitReached()),feedback().success(__("Element deleted"))},deleteServerAndLocalElement=()=>{$.postJson(delEltUrl,{uri:eltUri},response=>{response.deleted?deleteLocalElement():feedback().error(__("Element not deleted"))})},deleteElement=()=>{eltUri?deleteServerAndLocalElement():deleteLocalElement()};""===$input.val()?deleteElement():dialogConfirm(__("Please confirm you want to delete this list element."),deleteElement)})})}function handleCreateList($form){const isRemoteListCreation=($form.attr("action")||"").includes("remote");request({url:isRemoteListCreation?urlUtil.route("remote","Lists","taoBackOffice"):urlUtil.route("index","Lists","taoBackOffice"),method:"POST",data:isRemoteListCreation?$form.serialize():null}).then(response=>{response.data.uri=Uri.encode(response.data.uri),addNewList(response.data,isRemoteListCreation)}).catch(function(err){feedback().error(err.response.message||err)})}function addNewList(newList,isRemoteList){const $newListContainer=createListContainer(newList,isRemoteList);addHandlerListeners($newListContainer);const containerIdentifier=isRemoteList?"#panel-taoBo_remotelist":"#panel-taoBo_list";$(`${containerIdentifier} .data-container-wrapper`).append($newListContainer),isRemoteList||handleEditList(newList.uri)}function handleDeleteList(){const delListUrl=urlUtil.route("removeList","Lists","taoBackOffice"),$btn=$(this);dialogConfirm(__("Please confirm you want to delete this list. This operation cannot be undone."),function accept(){const uri=$btn.data("uri"),$list=$btn.parents(".data-container");$.postJson(delListUrl,{uri},response=>{response.deleted?(feedback().success(__("List deleted")),$list.remove()):feedback().error(__("List not deleted"))})})}function handleReloadList(){const reloadListUrl=urlUtil.route("reloadRemoteList","Lists","taoBackOffice"),uri=$(this).data("uri");$.postJson(reloadListUrl,{uri},response=>{response.saved?(feedback().success(__("List reloaded")),section.get("taoBo_remotelist").loadContentBlock(urlUtil.route("remote","Lists","taoBackOffice"))):feedback().error(response.message||__("List failed to be reloaded"))})}function addHandlerListeners($listContainer){$listContainer.on("click",".list-edit-btn",handleEditList),$listContainer.on("click",".list-delete-btn",handleDeleteList),$listContainer.on("click",".list-reload-btn",handleReloadList)}function createListContainer(newList,isRemoteList){return $(`<section id="list-data_${newList.uri}" class="data-container list-container">
                <header class="container-title">
                    <h6>${newList.label}</h6>
                </header>
                <div class="container-content" id="list-elements_${newList.uri}">
                    ${renderListElements(newList,isRemoteList)}
                </div>
                <footer class="data-container-footer action-bar">
                    <button
                        type="button"
                        title="${isRemoteList?__("Reload this list"):__("Edit this list")}"
                        class="icon-reload ${isRemoteList?"list-reload-btn":"list-edit-btn"} btn-info small rgt"
                        data-uri="${newList.uri}"
                    ></button>
                    <button
                        type="button"
                        title="${__("Delete this list")}"
                        class="icon-bin list-delete-btn btn-warning small rgt"
                        data-uri="${newList.uri}"
                    ></button>
                </footer>
            </section>`)}function renderListElements(newList,isRemoteList){let list=newList.elements.map((element,index)=>renderListElement(index,element.uri,element.label));if(isRemoteList&&newList.totalCount>newList.elements.length){const newElementIndex=newList.elements.length+1;list.push(renderListElement(newElementIndex,"","..."))}return`<ol data-testid="elements">${list.join("")}</ol>`}function renderListElement(index,uri,label){return`<li id="list-element_${index}">
            <span class="list-element" id="list-element_${index}_${Uri.encode(uri)}">${label}</span>
        </li>`}function getUriValue(targetUri){if("string"==typeof targetUri)return targetUri;return targetUri.currentTarget?$(targetUri.currentTarget).data("uri"):void 0}function handleLoadMore(){const $btn=$(this),listUri=getUriValue($btn.data("uri")),$listContainer=findListContainer(listUri),offset=$listContainer.find("ol").children("[id^=list-element]").length;$btn.find("a").text("Loading..."),$btn.find(".icon-loop").toggleClass("rotate"),loadListElements(listUri,offset).then(newListData=>{$btn.find("a").text("Load more"),$btn.find(".icon-loop").toggleClass("rotate"),extendListWithNewElements(newListData,$listContainer,listUri),$listContainer.find("form").length&&showElementsEditControls($listContainer)})}function loadListElements(listUri,offset,limit){const loadMoreUrl=urlUtil.route("getListElements","Lists","taoBackOffice"),res=new Promise(resolve=>{$.getJSON(loadMoreUrl,{listUri,offset,limit},response=>{resolve(response.data)})});return res}function extendListWithNewElements(_ref,listContainer){let{elements,totalCount}=_ref;const $list=listContainer.find("ol");let offset=$list.children("[id^=list-element]").length,buffer="";for(let i=0,id="",len=elements.length;i<len;i++)id=`list-element_${offset++}_`,buffer+=`<li id=${id}><span class='list-element' id='${id}${elements[i].uri}'>${elements[i].label}</span></li>`;$list.append(buffer).closest(".container-content").scrollTop($list.height()),offset===totalCount&&listContainer.find(".pagination-container").hide()}return{start(){$(".form-submitter").off("click").on("click",e=>{e.preventDefault(),handleCreateList($(e.target).closest("form"))}),$(".list-edit-btn").click(handleEditList),$(".list-delete-btn").click(handleDeleteList),$(".list-reload-btn").click(handleReloadList),$(".load-more-btn").click(handleLoadMore)}}}),define("taoBackOffice/controller/routes",[],function(){"use strict";return{Lists:{actions:{index:"controller/list/index",remote:"controller/list/index"}},Trees:{actions:{viewTree:"controller/tree/view"}}}}),define("taoBackOffice/treeRender",["jquery","lodash","taoBackOffice/lib/vis/vis","css!taoBackOffice/lib/vis/vis"],function($,_,vis){"use strict";function destroy(){null!==network&&(network.destroy(),network=null)}var network=null,treeContainer=null,settings=null,data=null,treeRender={init:function(container,treeData,options){if(!container instanceof Element)throw new TypeError("tree container must be specified");treeContainer=container,options=options||{},treeData=treeData||{nodes:[],edges:[]},settings={layout:{hierarchical:{sortMethod:"directed",levelSeparation:200}},nodes:{shape:"box",color:{border:"#222",background:"#f2f0ee",highlight:{border:"#222",background:"#f2f0ee"}},font:{face:"'Franklin Gothic', 'Franklin Gothic Medium', 'Source Sans Pro', sans-serif",color:"#222"}},edges:{smooth:!1,width:.2,color:{color:"#222"},arrows:{to:!0},physics:!1,scaling:{label:!1}}},$.extend(settings,options),data={nodes:treeData.nodes?treeData.nodes:[],edges:treeData.edges?treeData.edges:[]}},run:function(){destroy(),network=new vis.Network(treeContainer,data,settings),network.once("initRedraw",function(){100<data.nodes.length&&(network.setOptions($.extend(settings,{physics:{hierarchicalRepulsion:{nodeDistance:200},stabilization:{fit:!1}}})),network.fit({nodes:[data.nodes[0].id,data.nodes[1].id],animation:{duration:400,easingFunction:"linear"}}))})}};return treeRender}),define("taoBackOffice/controller/tree/view",["layout/actions/binder","uri","jquery","context","helpers","taoBackOffice/treeRender"],function(binder,uri,$,context,helpers,treeRender){"use strict";var itemRunnerController={start:function(){$(".tree-container").each(function(i,obj){var $container=$(obj),uri=$container.data("id");$.post(helpers._url("getTree","Trees","taoBackOffice"),{uri:uri},function(treeData){var $parent=$container.closest(".content-block"),resizeContainer=function(){$container.height($parent.height()-$parent.find(".panel").eq(0).outerHeight()),$container.width($parent.width())};$(window).on("resize",resizeContainer),resizeContainer(),treeRender.init($container[0],treeData),treeRender.run()})})}};return itemRunnerController}),function(c){var d=document,a="appendChild",i="styleSheet",s=d.createElement("style");s.type="text/css",d.getElementsByTagName("head")[0].appendChild(s),s.styleSheet?s.styleSheet.cssText=c:s.appendChild(d.createTextNode(c))}("@keyframes rota{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.list-container .container-content .list-element{display:flex;width:100%}.list-container .container-content .list-element-delete-btn{font-size:2em;cursor:pointer;margin-left:4px}.list-container .container-content .list-element__input-container{flex:1}.list-container .container-content .list-element__input-container__uri{display:none;align-items:center;margin-top:2px;margin-bottom:10px;background:#e1e2e3}.list-container .container-content .list-element .title{color:#222;border:1px #ccc solid;border-top-left-radius:2px;border-bottom-left-radius:2px;margin:0;padding:3px}.list-container .container-content .list-element .title~input{border-top-left-radius:0;border-bottom-left-radius:0;border-left:none}.list-container .container-content .list-element input{width:100%}.list-container .add-button-container{display:block;float:right;position:relative}.list-container .add-button-container .tooltip-container{width:100%;height:100%;position:absolute}.list-container .add-button-container .tooltip-hidden{display:none}.list-container .add-button-container .tooltipstered{display:block;width:100%;height:100%}.list-container .edit-uri{display:flex;color:initial;font-family:\"Source Sans Pro\",sans-serif}.section-container .content-block .data-container-wrapper .list-container form{background-color:#f3f1ef}.section-container .content-block .data-container-wrapper .list-container form .data-container-footer{border-top:0 !important}.with-uri .container-content .list-element__input-container__uri{display:flex}.container-content .pagination-container{display:flex;justify-content:space-between;padding:0 5px}.container-content .pagination-container>span{color:#838383}.container-content .pagination-container .icon-loop{display:inline-block;color:#3e7da7;font-size:1.25rem;margin-right:5px}.container-content .pagination-container .rotate{animation:rota 4s linear infinite}.create-list-wrapper{display:flex}.create-list-wrapper #createList{background:none;border:0;padding:0}.create-list-wrapper .form-toolbar{margin:10px 0 50px 0}\n\n/*# sourceMappingURL=../../../taoBackOffice/views/jsCss/list.css.map */"),define("taoBackOffice/loader/taoBackOffice.bundle",function(){});
//# sourceMappingURL=taoBackOffice.min.js.map